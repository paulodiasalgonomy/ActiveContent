<!DOCTYPE html>
<html>
<head>
    <title>Gerar Texto e Carrossel de Produtos.</title>
    <style>
        body { font-family: sans-serif; }
        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin: 10px;
            text-align: center;
            width: 150px;
            display: inline-block;
            vertical-align: top;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }
        .product-card img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .product-card a {
            text-decoration: none;
            color: #333;
            font-weight: bold;
            display: block;
            margin-top: 5px;
            word-wrap: break-word;
            overflow-x: hidden;
        }
        .product-card .buy-button {
            display: inline-block;
            padding: 8px 15px;
            background-color: #007bff; /* Cor Prim√°ria √âpoca */
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 0.9em;
        }
        #result {
            /* Mant√©m a formata√ß√£o de bloco do <pre> no <div> */
            white-space: pre-wrap; 
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 15px;
            min-height: 50px;
            background: #f4f4f4;
            border-radius: 5px;
        }
        #carousel-container h3 {
            margin-top: 30px;
            border-bottom: 2px solid #ccc;
            padding-bottom: 5px;
        }
        #products-carousel {
            overflow-x: auto;
            white-space: nowrap;
            padding: 10px 0;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        .error-message {
            color: red;
            font-weight: bold;
            padding: 15px;
            border: 1px solid red;
            background-color: #ffeaea;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h2>Gerar Texto e Carrossel Din√¢mico</h2>

    <input id="name" placeholder="Nome" value="Mariana" />
    <input id="city" placeholder="Cidade" value="S√£o Paulo" />
    
    <select id="gender">
        <option value="Feminino" selected>Feminino</option>
        <option value="Masculino">Masculino</option>
        <option value="Unissex">Unissex</option>
        <option value="Prefiro n√£o responder">Prefiro n√£o responder</option>
    </select>

    <button onclick="generate()">Gerar</button>

    <div id="result"></div>

    <div id="carousel-container">
    </div>

    <script>
// Fun√ß√£o para renderizar o carrossel HTML ou uma mensagem de erro
function renderCarousel(products, errorMessage) {
    const container = document.getElementById("carousel-container");
    container.innerHTML = ''; // Limpa o conte√∫do

    if (products && products.length > 0) {
        const carouselHTML = products.map(product => `
            <div class="product-card">
                <a href="${product.clickUrl || '#'}" target="_blank">
                    <img src="${product.imageURL || 'https://via.placeholder.com/150x150?text=Produto+Algonomy'}" alt="${product.name}"><br />
                    ${product.name}
                </a>
                <a href="${product.clickUrl || '#'}" class="buy-button" target="_blank">Comprar</a>
            </div>
        `).join('');

        container.innerHTML = `
            <h3>üõçÔ∏è Produtos Recomendados para voc√™:</h3>
            <div id="products-carousel">${carouselHTML}</div>
        `;
    } else if (errorMessage) {
        container.innerHTML = `
            <h3>‚ö†Ô∏è Status da Algonomy:</h3>
            <div class="error-message">${errorMessage}</div>
        `;
    }
}


async function generate() {
    const resultElement = document.getElementById("result");
    resultElement.textContent = "Buscando o clima e gerando recomenda√ß√µes...";
    resultElement.style.color = "#666";
    // Limpa o carrossel anterior
    document.getElementById("carousel-container").innerHTML = '';
    
    const name = document.getElementById("name").value;
    const city = document.getElementById("city").value;
    const gender = document.getElementById("gender").value;
    

    // --- VARI√ÅVEIS CONSTANTES ---
    // !!! SUBSTITUA SUA CHAVE GEMINI AQUI !!!
    const API_KEY = "AIzaSyB_Yee1hDlXgyi02OYhzOsN9AOfIrDXhFs"; 
    const MODEL_NAME = "gemini-2.0-flash";
    
    // --- VARI√ÅVEIS DA ALGONOMY ---
    // !!! SUBSTITUA SUAS CHAVES ALGONOMY AQUI !!!
    const ALGONOMY_BASE_URL = "https://recs.richrelevance.com/rrserver/api/rrPlatform/recsForPlacements";
    const ALGONOMY_PARAMS = "apiKey=c85912f892c73e30&apiClientKey=eac9cfa39420d536&sessionId=algtestsession345975231641&userId=algtestuser463166675929&includeStrategyData=true&excludeItemAttributes=true&categoryData=false&excludeHtml=true";
    
    // Mapeamento da tag Gemini para o placement Algonomy
    const placementMap = {
        'SOL_CALOR': 'email_page.sol',
        'FRIO_SECO': 'email_page.frio',
        'CHUVA_UMIDADE': 'email_page.chuva',
        'TEMPO_AMENO': 'email_page.ameno'
    };
    // ----------------------------

    // 1. CHAME O GEMINI PARA OBTER A TAG CLIM√ÅTICA PADRONIZADA
    let weatherTag = "TEMPO_AMENO"; 
    const weatherPrompt = `
        Analise a previs√£o do tempo para ${city} nos pr√≥ximos 5 dias. 
        Responda APENAS com uma das seguintes palavras-chave, sem texto adicional ou explica√ß√£o, 
        em caixa alta: [SOL_CALOR], [CHUVA_UMIDADE], [FRIO_SECO], ou [TEMPO_AMENO]. 
        Se a previs√£o for mista ou incerta, use [TEMPO_AMENO].
    `;

    try {
        const weatherResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: weatherPrompt }] }] })
        });
        const weatherData = await weatherResponse.json();
        
        if (!weatherResponse.ok) {
             throw new Error(`Erro Gemini (Passo 1): ${weatherData.error ? weatherData.error.message : JSON.stringify(weatherData)}`);
        }

        if (weatherData.candidates && weatherData.candidates.length > 0) {
            weatherTag = weatherData.candidates[0].content.parts[0].text.trim().toUpperCase();
        }
    } catch (e) {
        console.error("Erro ao buscar tag clim√°tica, usando default:", e);
        resultElement.style.color = "red";
        resultElement.textContent = `Erro no Passo 1 (Gemini Key?): ${e.message || "Erro desconhecido"}. Usando clima default: ${weatherTag}.`;
    }
    
    resultElement.textContent = `Tag do Clima Obtida: ${weatherTag}. Tentando chamar API de Recomenda√ß√£o Algonomy...`;

    // 2. CHAMADA REAL √Ä API ALGONOMY
    
    const placement = placementMap[weatherTag] || 'email_page.ameno';
    const algonomyUrl = `${ALGONOMY_BASE_URL}?${ALGONOMY_PARAMS}&placements=${placement}`;
    
    let recommendedProductsData = []; 
    let recommendedProductsNames = "N√£o foi poss√≠vel obter recomenda√ß√µes da Algonomy."; 
    let algonomyErrorMessage = "";

    try {
        const algonomyResponse = await fetch(algonomyUrl);
        const algonomyData = await algonomyResponse.json();

        if (algonomyResponse.ok && algonomyData && algonomyData.placements && algonomyData.placements.length > 0) {
            
            // Tenta obter os produtos usando a chave 'recommendedProducts' ou 'recommendations'
            const recs = algonomyData.placements[0].recommendedProducts || algonomyData.placements[0].recommendations;

            if (recs && recs.length > 0) {
                
                const validProducts = recs
                    .slice(0, 5) // Pega at√© 5 produtos para o carrossel
                    .map(rec => ({
                        name: rec.name,
                        imageURL: rec.imageURL, 
                        clickUrl: rec.clickUrl 
                    }))
                    .filter(p => p.name); // Garante que pelo menos o nome exista

                if (validProducts.length > 0) {
                    recommendedProductsData = validProducts;
                    recommendedProductsNames = recommendedProductsData.map(p => p.name).join(", ");
                } else {
                     algonomyErrorMessage = "Algonomy retornou dados, mas a lista de produtos recomendados est√° vazia para o placement: " + placement;
                     recommendedProductsNames = "N√£o foram encontrados produtos da Algonomy para este cen√°rio.";
                }

            } else {
                 algonomyErrorMessage = "Algonomy retornou a estrutura do placement, mas a lista de produtos (recommendedProducts/recommendations) est√° vazia.";
                 recommendedProductsNames = "N√£o foram encontrados produtos da Algonomy para este cen√°rio.";
            }

        } else {
            algonomyErrorMessage = `Erro da API Algonomy: Resposta inv√°lida ou sem recomenda√ß√µes. Status: ${algonomyResponse.statusText}`;
            if (algonomyData.error) {
                algonomyErrorMessage += ` Detalhe: ${algonomyData.error.message}`;
            }
        }

    } catch (e) {
        console.error("Erro na chamada da API Algonomy (Passo 2):", e);
        algonomyErrorMessage = `Erro de rede ou CORS ao chamar a Algonomy: ${e.message}`;
    }

    // Se houve erro na Algonomy, seta a mensagem de erro para ser usada no carrossel
    if (algonomyErrorMessage && recommendedProductsData.length === 0) {
        recommendedProductsNames = "N√£o foi poss√≠vel obter recomenda√ß√µes da Algonomy.";
    }

    resultElement.textContent = `Tag do Clima: ${weatherTag}. Status Algonomy: ${algonomyErrorMessage ? 'Falha' : 'Sucesso'}. Gerando mensagem final...`;
    
    // 3. MONTAGEM DO PROMPT FINAL COM DADOS DA ALGONOMY
    
    const finalPrompt = `
        Aja como um especialista em beleza da √âpoca Cosm√©ticos.
        Voc√™ deve gerar uma mensagem amig√°vel, pessoal e de alta convers√£o para o usu√°rio final.

        Instru√ß√µes:
        1. Comece com uma sauda√ß√£o calorosa e personalizada (use o nome).
        2. Mencione a cidade (${city}) para gerar conex√£o.
        3. Use a TAG CLIM√ÅTICA para adicionar uma dica de beleza que se relacione com o clima.
        4. Use os PRODUTOS RECOMENDADOS para criar uma oferta irresist√≠vel.
        5. Use a informa√ß√£o de G√äNERO para refinar o tom da mensagem.
        6. SE OS PRODUTOS RECOMENDADOS FOREM UMA MENSAGEM DE ERRO/FALHA ("N√£o foi poss√≠vel obter..."), MANTENHA A DICA CLIM√ÅTICA, MAS ESCREVA UM TEXTO GERAL SOBRE AUTOCUIDADO E INSPIRA√á√ÉO EM VEZ DE MENCIONAR PRODUTOS ESPEC√çFICOS.
        7. O tom deve ser inspirador, luxuoso e focado em autocuidado.
        8. O texto final deve ser natural, humanizado e pronto para ser enviado.
        9. Use **asteriscos duplos** para indicar negrito, se for o caso (Ex: **Melhor Protetor**).
        10. N√ÉO INCLUA os t√≠tulos 'Dados do Cliente:' ou 'Instru√ß√µes:'.

        Dados do Cliente:
        Nome: ${name}
        Cidade: ${city}
        G√™nero Preferido: ${gender}
        Tag Clim√°tica: ${weatherTag}
        Produtos Recomendados: ${recommendedProductsNames}
    `;

    // 4. CHAMADA FINAL AO GEMINI PARA GERAR O TEXTO DE MARKETING
    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{ parts: [{ text: finalPrompt }] }],
                generationConfig: { 
                    temperature: 0.8
                }
            })
        });

        const data = await response.json();

        if (response.ok && data.candidates && data.candidates.length > 0) {
            resultElement.style.color = "#000";
            
            // NOVO: Converte o markdown de negrito para HTML e usa innerHTML para renderizar
            let generatedText = data.candidates[0].content.parts[0].text;
            let finalHtml = generatedText.replace(/\*\*(.*?)\*\*/gs, '<strong>$1</strong>');
            
            resultElement.innerHTML = finalHtml; 
            
            // Renderiza o carrossel com os dados da Algonomy (ou a mensagem de erro da Algonomy)
            renderCarousel(recommendedProductsData, algonomyErrorMessage); 
            
        } else {
            console.error("Erro API (Passo 4):", data);
            resultElement.style.color = "red";
            const errorMsg = data.error ? data.error.message : JSON.stringify(data);
            resultElement.textContent = "Erro ao gerar a mensagem final (Passo 4). Verifique se a sua CHAVE GEMINI est√° correta: " + errorMsg;
        }

    } catch (error) {
        console.error("Erro de Rede (Passo 4):", error);
        resultElement.textContent = "Erro de conex√£o. Verifique sua internet ou se a CHAVE GEMINI foi digitada corretamente.";
    }
}
    </script>
</body>
</html>